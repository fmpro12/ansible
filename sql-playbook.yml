- name: Update web servers
  hosts: 127.0.0.1
  
  tasks:
  - name:  
    pip:
       name: "{{ item }}"
       state: present
    with_items:
          - PyMySQL
          - boto
          - boto3
          - botocore
          - jmespath

  - name: lookup secretsmanager user
    debug: 
       msg: "{{ lookup('amazon.aws.aws_secret', 'qa/ansible', region='us-west-2') | from_json | json_query('user') }}"
       
  - name: Create database user with name 'bob2' and password '12345' with all database privileges
    community.mysql.mysql_user:
        login_host: "{{ '10.42.0.38' if host == 'yan_local' else '10.42.0.39' if host == 'yan_test' }}"
        login_port: "{{ '3306' if host == 'yan_local' else '3308' if host == 'yan_test' }}"
        login_user: "{{ lookup('amazon.aws.aws_secret', 'qa/ansible', region='us-west-2') | from_json | json_query('user') }}"
        login_password: "{{ dbpassword }}"
        host: '%'
        password: "{{ password }}"
        name: "{{ username }}"
        priv: '{{ database }}.*:{{ permissions }}'
        state: present
    when: username != "root23" and username != "root22"
               
